# Robot 제어를 위한 MCU 프로그래밍

# 모터 Timer 테스트

// 프로젝트에 CAN_Unit.c, CAN_Unit.h , CAN2Motor.c, CAN2Motor.h 추가

//  CAN_Unit.c

uint8_t setTxMessageHeader(uint32_t msg_ID, uint8_t * dataValue)
{
  uint8_t res = 0;
  uint8_t i;
  TxMessage.StdId = msg_ID;
  TxMessage.IDE = CAN_ID_STD;
  TxMessage.RTR = CAN_RTR_DATA;
  TxMessage.DLC = 8;

  for(i=0; i<8 ;i++)
  {
    txData[i] = dataValue[i];
  }  
  txMailbox = HAL_CAN_GetTxMailboxesFreeLevel(&hcan);
  HAL_StatusTypeDef state = HAL_CAN_AddTxMessage(&hcan, &TxMessage, &txData[0], &txMailbox);
  if(state == HAL_OK)
    res = 1;
  else {
    HAL_CAN_StateTypeDef statetype = HAL_CAN_GetState(&hcan);
    uint32_t err = HAL_CAN_GetError(&hcan);
    PRINTF("FAIL TO SEND TX statetype:%d err:%d\n", statetype, err);
    res = 0;
  }
  
  return res;
}

 void HAL_CAN_RxFifo1MsgPendingCallback(CAN_HandleTypeDef *hcan)
{
  if(hcan->Instance == CAN1)
  {
    HAL_CAN_GetRxMessage(hcan, CAN_RX_FIFO1, &RxMessage, &rxData[0]);
    can1_rx_flag = 1;
    
  }
}

uint8_t getRxMessageHeader(uint32_t * msg_ID, uint8_t * dataValue)
{ 
  uint8_t res = can1_rx_flag;
  if(can1_rx_flag == 1)
  {
    uint8_t i;
    can1_rx_flag = 0;
    
    for(i=0; i<8 ;i++)
    {
      dataValue[i] = rxData[i];
    }
   
    *msg_ID = RxMessage.StdId;

  }
  return res;
}  

//CAN2Motor.c


