# Robot 제어를 위한 MCU 프로그래밍

# 모터 Timer 테스트

// 프로젝트에 MotorCtl.c, MotorCtl.h 추가

//--------------------------------------------
// 모터 구동 테스트
// MotorCtl.c

//모터 제어 명령
void doMotor(uint8_t mnum, uint8_t dir, uint32_t vel)
{
  //uint32_t pulse = vel;
  SetPulse4FanPWM(mnum, dir, vel);
}

//PWM 설정
void SetPulse4FanPWM(uint8_t mnum, uint8_t dir, uint32_t pulseVal)
{    
  if(mnum == 0) {
    if(dir == 1) {
      HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_2);
      HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_1);
      if(pulseVal > 0) {
        MX_TIM_SetPulse(mnum, dir, pulseVal);
        HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_1);
      } else {
        HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_1);
      }
    } else if(dir == 0) {
      HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_1);
      HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_2);
      if(pulseVal > 0) {
        MX_TIM_SetPulse(mnum, dir, pulseVal);
        HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_2);
      } else {
        HAL_TIM_PWM_Stop(&htim2, TIM_CHANNEL_2);
      }
    }        
  }
  else if(mnum == 1) {
    if(dir == 1) {
      HAL_TIM_PWM_Stop(&htim3, TIM_CHANNEL_1);
      HAL_TIM_PWM_Stop(&htim3, TIM_CHANNEL_2);
      if(pulseVal > 0) {
        MX_TIM_SetPulse(mnum, dir, pulseVal);
        HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_1);
      } else {
        HAL_TIM_PWM_Stop(&htim3, TIM_CHANNEL_1);
      }
    } else if (dir == 0) {
      HAL_TIM_PWM_Stop(&htim3, TIM_CHANNEL_1);
      HAL_TIM_PWM_Stop(&htim3, TIM_CHANNEL_2);
      if(pulseVal > 0) {
        MX_TIM_SetPulse(mnum, dir, pulseVal);
        HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_2);
      } else {
        HAL_TIM_PWM_Stop(&htim3, TIM_CHANNEL_2);
      }
    } 
  }
}


//--------------------------------------------
// 모터 구동 테스트
// main.c

#include "MotorCtl.h"

void InitDriving(void)
{
  //void setData4PWMMotors(uint8_t mnum, uint8_t pulse, uint8_t speed, int8_t direction, uint8_t enable)
  setData4PWMMotors(LEFTMOTOR, 100, 0, 0, 0);
  setData4PWMMotors(RIGHTMOTOR, 100, 0, 0, 0);

}

#부교재 참조하여 main 함수 완성

//--------------------------------------------

// 프로젝트에 CAN_Unit.c, CAN_Unit.h CAN2Motor.c, CAN2Motor.h 추가
// main.c

//--------------------------------------------
// CAN2모터 구동 테스트
CAN2Motor 에 
void InitDriving(void)
{
  //void setData4PWMMotors(uint8_t mnum, uint8_t pulse, uint8_t speed, int8_t direction, uint8_t enable)
  setData4PWMMotors(LEFTMOTOR, 100, 10, 1, 1);
  setData4PWMMotors(RIGHTMOTOR, 100, 10, 1, 1);

  Start_CAN();
  
  RunningMode = RUN_DRIVING;

}

main.c에
#include "CAN2Motor.h"
